name: CI

on:
  pull_request:
    tags-ignore: ["*"]
    branches: [c4t, dev]
  push:
    branches: [c4t, dev]
  workflow_dispatch:

# Cancel ongoing workflow runs if a new one is started
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  go_version: "~1.23.1"

jobs:
  unit:
    name: Unit Tests
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - name: Update dependencies
        run: git submodule update --init
      - uses: actions/setup-go@v3
        with:
          go-version: ${{ env.go_version }}
      - name: Install libolm
        run: sudo apt update && sudo apt-get install -y libolm-dev
      - name: build_test
        shell: bash
        run: ./scripts/build_test.sh
  lint:
    name: Static Analysis
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - name: Update dependencies
        run: git submodule update --init
      - uses: actions/setup-go@v3
        with:
          go-version: ${{ env.go_version }}
      - name: Install libolm
        run: sudo apt update && sudo apt-get install -y libolm-dev
      - name: GolangCI-Lint
        shell: bash
        run: ./scripts/lint.sh
  go_mod_tidy:
    name: Check state of go.mod and go.sum
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - name: Update dependencies
        run: git submodule update --init
      - uses: actions/setup-go@v3
        with:
          go-version: ${{ env.go_version }}
      - name: Go Mod Tidy
        shell: bash
        run: go mod tidy
      - name: Check Clean Branch
        shell: bash
        run: .github/workflows/check-clean-branch.sh
